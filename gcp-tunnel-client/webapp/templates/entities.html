<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity Configuration - GCP Tunnel</title>
    <style>
        :root {
            --primary: #03a9f4;
            --success: #4caf50;
            --error: #f44336;
            --bg: #1c1c1c;
            --card: #2d2d2d;
            --text: #ffffff;
            --text-muted: #9e9e9e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
            text-decoration: none;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #404040; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .search-box {
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-size: 14px;
            width: 300px;
        }
        .search-box:focus { outline: none; border-color: var(--primary); }
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .filter-chip {
            padding: 6px 12px;
            border-radius: 16px;
            background: #404040;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .filter-chip:hover { background: #505050; }
        .filter-chip.active { background: var(--primary); }
        .entity-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        .entity-row {
            display: grid;
            grid-template-columns: 40px 1fr 150px 150px 100px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #404040;
        }
        .entity-row:last-child { border-bottom: none; }
        .entity-row:hover { background: rgba(255,255,255,0.03); }
        .entity-header {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .entity-name {
            font-weight: 500;
        }
        .entity-id {
            font-size: 12px;
            color: var(--text-muted);
            font-family: monospace;
        }
        .domain-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: #404040;
        }
        input[type="text"] {
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 6px 10px;
            color: white;
            font-size: 13px;
            width: 100%;
        }
        input[type="text"]:focus { outline: none; border-color: var(--primary); }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .status.success { background: rgba(76, 175, 80, 0.2); }
        .status.error { background: rgba(244, 67, 54, 0.2); }
        .status.info { background: rgba(3, 169, 244, 0.2); }
        .hidden { display: none; }
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff40;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .count-badge {
            background: var(--primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }
        .tip {
            font-size: 13px;
            color: var(--text-muted);
            padding: 12px;
            background: rgba(3, 169, 244, 0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header-row">
                <div>
                    <h1>Entity Configuration</h1>
                    <p class="subtitle">Configure which entities Google Assistant can control</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <a href="{{ ingress_path }}/" class="btn btn-secondary">‚Üê Back</a>
                    <button id="save-btn" class="btn btn-success" onclick="saveEntities()">Save Changes</button>
                </div>
            </div>

            <div id="status-msg" class="status hidden"></div>

            <div class="tip">
                <strong>Tip:</strong> Use aliases to give entities alternative names like "the lamp" or "bedroom light".
                Set a room to automatically assign entities to Google Home rooms.
            </div>

            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                <input type="text" class="search-box" id="search" placeholder="Search entities..." oninput="filterEntities()">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="show-exposed-only" onchange="filterEntities()">
                    Show exposed only
                </label>
            </div>

            <div class="filters" id="domain-filters"></div>

            <div class="entity-list">
                <div class="entity-row entity-header">
                    <div>Expose</div>
                    <div>Entity</div>
                    <div>Custom Name</div>
                    <div>Room</div>
                    <div>Aliases</div>
                </div>
                <div id="entity-rows">
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                        <span class="loader"></span> Loading entities...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ingressPath = "{{ ingress_path }}";
        let allEntities = [];
        let selectedDomains = new Set();

        async function loadEntities() {
            try {
                const resp = await fetch(ingressPath + '/api/entities');
                const data = await resp.json();

                if (data.error) {
                    showStatus('error', data.error);
                    return;
                }

                allEntities = data.entities;
                buildDomainFilters();
                renderEntities();

            } catch (e) {
                showStatus('error', 'Failed to load entities: ' + e.message);
            }
        }

        function buildDomainFilters() {
            const domains = [...new Set(allEntities.map(e => e.domain))].sort();
            const container = document.getElementById('domain-filters');

            container.innerHTML = domains.map(domain => {
                const count = allEntities.filter(e => e.domain === domain).length;
                return `<span class="filter-chip" data-domain="${domain}" onclick="toggleDomain('${domain}')">${domain} <span class="count-badge">${count}</span></span>`;
            }).join('');
        }

        function toggleDomain(domain) {
            if (selectedDomains.has(domain)) {
                selectedDomains.delete(domain);
            } else {
                selectedDomains.add(domain);
            }

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', selectedDomains.has(chip.dataset.domain));
            });

            filterEntities();
        }

        function filterEntities() {
            const search = document.getElementById('search').value.toLowerCase();
            const exposedOnly = document.getElementById('show-exposed-only').checked;

            const filtered = allEntities.filter(entity => {
                // Domain filter
                if (selectedDomains.size > 0 && !selectedDomains.has(entity.domain)) {
                    return false;
                }
                // Exposed filter
                if (exposedOnly && !entity.expose) {
                    return false;
                }
                // Search filter
                if (search) {
                    const searchStr = `${entity.entity_id} ${entity.friendly_name} ${entity.name || ''} ${(entity.aliases || []).join(' ')}`.toLowerCase();
                    if (!searchStr.includes(search)) {
                        return false;
                    }
                }
                return true;
            });

            renderEntities(filtered);
        }

        function renderEntities(entities = allEntities) {
            const container = document.getElementById('entity-rows');

            if (entities.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No entities found</div>';
                return;
            }

            container.innerHTML = entities.map((entity, idx) => {
                const origIdx = allEntities.findIndex(e => e.entity_id === entity.entity_id);
                return `
                <div class="entity-row" data-idx="${origIdx}">
                    <div>
                        <input type="checkbox" ${entity.expose ? 'checked' : ''} onchange="updateEntity(${origIdx}, 'expose', this.checked)">
                    </div>
                    <div>
                        <div class="entity-name">${entity.friendly_name}</div>
                        <div class="entity-id">${entity.entity_id} <span class="domain-badge">${entity.domain}</span></div>
                    </div>
                    <div>
                        <input type="text" placeholder="Custom name" value="${entity.name || ''}" onchange="updateEntity(${origIdx}, 'name', this.value)">
                    </div>
                    <div>
                        <input type="text" placeholder="Room" value="${entity.room || ''}" onchange="updateEntity(${origIdx}, 'room', this.value)">
                    </div>
                    <div>
                        <button class="btn btn-sm btn-secondary" onclick="editAliases(${origIdx})">
                            ${(entity.aliases || []).length || 'Add'}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateEntity(idx, field, value) {
            allEntities[idx][field] = value;
        }

        function editAliases(idx) {
            const entity = allEntities[idx];
            const current = (entity.aliases || []).join(', ');
            const input = prompt(`Aliases for ${entity.friendly_name}\n(comma-separated):`, current);

            if (input !== null) {
                entity.aliases = input.split(',').map(s => s.trim()).filter(s => s);
                filterEntities(); // Re-render
            }
        }

        async function saveEntities() {
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Saving...';

            try {
                const resp = await fetch(ingressPath + '/api/entities', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({entities: allEntities})
                });

                const data = await resp.json();

                if (data.success) {
                    showStatus('success', `Saved ${data.count} entity configurations. Restart HA Core to apply.`);
                } else {
                    showStatus('error', data.error);
                }

            } catch (e) {
                showStatus('error', 'Save failed: ' + e.message);
            }

            btn.disabled = false;
            btn.innerHTML = 'Save Changes';
        }

        function showStatus(type, message) {
            const el = document.getElementById('status-msg');
            el.className = 'status ' + type;
            el.textContent = message;
            el.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => el.classList.add('hidden'), 5000);
            }
        }

        // Load on page load
        loadEntities();
    </script>
</body>
</html>
