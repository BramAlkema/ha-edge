# nginx config for Cloud Run chisel tunnel
# Port 8080: external (Cloud Run)
# Port 9000: chisel WebSocket server (internal)
# Port 9001: reverse tunnel endpoint (internal)

worker_processes 1;
error_log /dev/stderr warn;
pid /run/nginx/nginx.pid;

events {
    worker_connections 256;
}

http {
    include /etc/nginx/mime.types;
    access_log /dev/stdout;

    # Upstream for chisel WebSocket server
    upstream chisel {
        server 127.0.0.1:9000;
    }

    # Upstream for reverse tunnel (HA traffic)
    upstream tunnel {
        server 127.0.0.1:9001;
    }

    server {
        listen 8080;
        server_name _;

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Static files (privacy policy, logos)
        location /static/ {
            alias /var/www/static/;
            expires 1d;
        }

        # Privacy policy page (rewrite to static file)
        location = /privacy {
            rewrite ^ /static/privacy.html last;
        }

        # WebSocket connections go to chisel server
        # Chisel uses Upgrade: websocket header
        location / {
            # Check for WebSocket upgrade
            set $backend tunnel;
            if ($http_upgrade = "websocket") {
                set $backend chisel;
            }

            proxy_pass http://$backend;
            proxy_http_version 1.1;

            # WebSocket headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Standard proxy headers
            # Use localhost as Host for HA (external Host causes 400 error)
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;

            # Timeouts for WebSocket (60 min = 3600s, but Cloud Run limits to 60 min anyway)
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;

            # Buffer settings
            proxy_buffering off;
        }
    }

    # Connection upgrade mapping
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
}
