# =============================================================================
# Home Assistant Edge - nginx Configuration
# =============================================================================
#
# This is the "front door" of the edge layer. It routes traffic to:
#
#   BOUNCER (security):
#   - Rate limiting (nginx limit_req)
#   - Remote UI toggle (auth_request to edge proxy)
#   - Header stripping (prevent trusted_proxies bypass)
#
#   BUTLER (intelligence):
#   - Google Assistant → Edge Proxy (caching, logging)
#   - Remote UI → Tunnel → Home Assistant
#   - Local SDK → Static files
#
# Architecture:
#   Internet:443 → Cloud Run:8080 (this nginx)
#                              ├── /api/google_assistant → :8081 (edge proxy)
#                              ├── /api/websocket → :9001 (tunnel) → HA
#                              ├── / (websocket) → :9000 (chisel server)
#                              ├── / (http) → :9001 (tunnel) → HA
#                              └── /edge/* → :8081 (edge proxy management)
#
# Ports:
#   8080 - External (Cloud Run ingress)
#   8081 - Edge proxy (Python/gunicorn)
#   9000 - Chisel WebSocket server (tunnel control)
#   9001 - Reverse tunnel endpoint (to HA)
#
# =============================================================================

worker_processes 1;
error_log /dev/stderr warn;
pid /run/nginx/nginx.pid;

events {
    worker_connections 256;
}

http {
    include /etc/nginx/mime.types;
    access_log /dev/stdout;

    # =========================================================================
    # Rate Limiting (BOUNCER)
    # =========================================================================
    # Uses $binary_remote_addr (IP) as key, 10MB zone (~160k IPs)

    # UI requests: 10/s with burst of 20 (generous for page loads)
    limit_req_zone $binary_remote_addr zone=ui_limit:10m rate=10r/s;

    # API requests: 30/s with burst of 10 (Google Assistant needs headroom)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

    # Return 429 (not 503) when rate limited
    limit_req_status 429;

    # =========================================================================
    # Upstreams
    # =========================================================================

    # Chisel WebSocket server - tunnel control channel
    upstream chisel {
        server 127.0.0.1:9000;
    }

    # Edge proxy - caching, logging, rate limiting for Assistant API
    upstream edge_proxy {
        server 127.0.0.1:8081;
    }

    # Reverse tunnel endpoint - direct path to Home Assistant
    upstream tunnel {
        server 127.0.0.1:9001;
    }

    # =========================================================================
    # Main Server
    # =========================================================================

    server {
        listen 8080;
        server_name _;

        # Security headers (BOUNCER)
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        # Note: HSTS handled by Cloud Run

        # ---------------------------------------------------------------------
        # Health Check (always allowed)
        # ---------------------------------------------------------------------
        location = /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # ---------------------------------------------------------------------
        # Static Files (always allowed)
        # ---------------------------------------------------------------------

        # Tunnel static files (privacy, setup page)
        # Path: /tunnel-static/ to avoid conflict with HA's /static/
        location /tunnel-static/ {
            alias /var/www/static/;
            expires 1d;
            add_header Cache-Control "public, max-age=86400";
        }

        # Local Home SDK JavaScript bundle
        # Served to Google devices for local fulfillment
        location /local-sdk/ {
            alias /var/www/static/local-sdk/;
            add_header Content-Type "application/javascript";
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=3600";
        }

        # Convenience rewrites
        location = /privacy {
            rewrite ^ /tunnel-static/privacy.html last;
        }
        location = /setup {
            rewrite ^ /tunnel-static/setup.html last;
        }

        # ---------------------------------------------------------------------
        # Google Assistant API (→ Edge Proxy)
        # ---------------------------------------------------------------------
        # Routes through edge proxy for caching, offline fallback, logging

        location /api/google_assistant {
            limit_req zone=api_limit burst=10 nodelay;

            proxy_pass http://edge_proxy;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ---------------------------------------------------------------------
        # Alexa Smart Home API (→ Edge Proxy)
        # ---------------------------------------------------------------------
        # Routes through edge proxy for caching, offline fallback, logging
        # Called by AWS Lambda proxy

        location /api/alexa {
            limit_req zone=api_limit burst=10 nodelay;

            proxy_pass http://edge_proxy;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # ---------------------------------------------------------------------
        # Edge Proxy Management
        # ---------------------------------------------------------------------
        # Stats, cache control, remote UI toggle

        location /edge/ {
            proxy_pass http://edge_proxy/edge/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Internal auth_request endpoint for remote UI check
        location = /_remote_ui_check {
            internal;
            proxy_pass http://edge_proxy/edge/remote-ui/check;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            # Pass upgrade header so edge proxy can allow websockets
            proxy_set_header X-Original-Upgrade $http_upgrade;
        }

        # ---------------------------------------------------------------------
        # OAuth Endpoints (always allowed - needed for Assistant linking)
        # ---------------------------------------------------------------------

        location /auth/ {
            limit_req zone=api_limit burst=10 nodelay;

            proxy_pass http://tunnel;
            proxy_http_version 1.1;
            proxy_set_header Host $host;

            # Strip proxy headers (prevent trusted_proxies issues)
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";

            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            # OAuth state fix: HA drops state param, Google requires it
            proxy_redirect ~^(https://oauth-redirect\.googleusercontent\.com/r/[^?]+\?code=[^&]+)(.*)$ $1$2$oauth_state_suffix;
            proxy_redirect ~^(https://oauth-redirect-sandbox\.googleusercontent\.com/r/[^?]+\?code=[^&]+)(.*)$ $1$2$oauth_state_suffix;
        }

        # ---------------------------------------------------------------------
        # Home Assistant WebSocket (Remote UI real-time updates)
        # ---------------------------------------------------------------------
        # Requires remote_ui_enabled=true in add-on config

        location = /api/websocket {
            auth_request /_remote_ui_check;
            error_page 403 = @ui_disabled;

            proxy_pass http://tunnel;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;

            # Strip proxy headers
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";

            # Long timeout for WebSocket (Cloud Run max: 60 min)
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }

        # ---------------------------------------------------------------------
        # Error Pages
        # ---------------------------------------------------------------------

        location @ui_disabled {
            default_type text/html;
            return 403 '<!DOCTYPE html>
<html><head><title>Remote UI Disabled</title></head>
<body style="font-family:system-ui;padding:40px;text-align:center">
<h1>Remote UI Disabled</h1>
<p>Enable <code>remote_ui_enabled: true</code> in the HA Edge add-on configuration.</p>
<p><a href="/setup">Setup Instructions</a></p>
</body></html>';
        }

        # ---------------------------------------------------------------------
        # Catch-All: Chisel WebSocket + Remote UI HTTP
        # ---------------------------------------------------------------------
        # WebSocket upgrade → Chisel (tunnel control)
        # HTTP requests → Tunnel → HA (remote UI)

        location / {
            # Route based on upgrade header
            set $backend tunnel;
            if ($http_upgrade = "websocket") {
                set $backend chisel;
            }

            # Check remote UI access (allows websocket through)
            auth_request /_remote_ui_check;
            error_page 403 = @ui_disabled;

            # Rate limit UI requests
            limit_req zone=ui_limit burst=20 nodelay;

            proxy_pass http://$backend;
            proxy_http_version 1.1;

            # WebSocket headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;

            # Strip proxy headers to avoid trusted_proxies requirement
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";

            # WebSocket timeout (Cloud Run max: 60 min)
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # Mappings
    # =========================================================================

    # WebSocket connection upgrade
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # OAuth state fix: append state if missing from redirect
    map $upstream_http_location $oauth_state_suffix {
        default "&state=$arg_state";
        "~state=" "";
    }
}
