# nginx config for Cloud Run chisel tunnel with edge proxy
# Port 8080: external (Cloud Run)
# Port 8081: edge proxy (caching, rate limiting, logging)
# Port 9000: chisel WebSocket server (internal)
# Port 9001: reverse tunnel endpoint (internal)
#
# Remote UI toggle controlled via edge proxy /edge/remote-ui endpoint
# (set by HA add-on based on remote_ui_enabled config option)

worker_processes 1;
error_log /dev/stderr warn;
pid /run/nginx/nginx.pid;

events {
    worker_connections 256;
}

http {
    include /etc/nginx/mime.types;
    access_log /dev/stdout;

    # Rate limiting zones
    # UI: 10 requests/second with burst of 20
    limit_req_zone $binary_remote_addr zone=ui_limit:10m rate=10r/s;
    # API: 30 requests/second (Google Assistant needs headroom)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

    # Upstream for chisel WebSocket server
    upstream chisel {
        server 127.0.0.1:9000;
    }

    # Upstream for edge proxy (smart caching layer)
    upstream edge_proxy {
        server 127.0.0.1:8081;
    }

    # Upstream for reverse tunnel (direct, bypasses edge proxy)
    upstream tunnel {
        server 127.0.0.1:9001;
    }

    server {
        listen 8080;
        server_name _;

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Tunnel static files (privacy policy, setup page)
        # Using /tunnel-static/ to avoid conflict with HA's /static/
        location /tunnel-static/ {
            alias /var/www/static/;
            expires 1d;
        }

        # Local SDK app.js - for Google Local Home SDK
        # Serve with correct MIME type and CORS for Google devices
        location /local-sdk/ {
            alias /var/www/static/local-sdk/;
            add_header Content-Type application/javascript;
            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control "public, max-age=3600";
        }

        # Privacy policy page (rewrite to static file)
        location = /privacy {
            rewrite ^ /tunnel-static/privacy.html last;
        }

        # Setup page with QR codes and copy buttons
        location = /setup {
            rewrite ^ /tunnel-static/setup.html last;
        }

        # Google Assistant API → edge proxy (caching, rate limiting, logging)
        location /api/google_assistant {
            proxy_pass http://edge_proxy;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Edge proxy stats and management
        location /edge/ {
            proxy_pass http://edge_proxy/edge/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # Internal location for remote UI auth check
        # Passes X-Original-Upgrade header so edge proxy can allow websockets through
        location = /_remote_ui_check {
            internal;
            proxy_pass http://edge_proxy/edge/remote-ui/check;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-Upgrade $http_upgrade;
        }

        # HA WebSocket - route through tunnel to Home Assistant
        # This enables the remote UI with real-time updates
        # Requires remote_ui_enabled via edge proxy
        location = /api/websocket {
            auth_request /_remote_ui_check;
            error_page 403 = @ui_disabled;

            proxy_pass http://tunnel;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }

        # OAuth endpoints - always allowed (needed for Google Assistant linking)
        location /auth/ {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://tunnel;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            # OAuth state fix
            proxy_redirect ~^(https://oauth-redirect\.googleusercontent\.com/r/[^?]+\?code=[^&]+)(.*)$ $1$2$oauth_state_suffix;
            proxy_redirect ~^(https://oauth-redirect-sandbox\.googleusercontent\.com/r/[^?]+\?code=[^&]+)(.*)$ $1$2$oauth_state_suffix;
        }

        # Error page for disabled remote UI
        location @ui_disabled {
            default_type text/html;
            return 403 '<html><body><h1>Remote UI Disabled</h1><p>Enable remote_ui_enabled in the GCP Tunnel add-on configuration.</p></body></html>';
        }

        # Chisel tunnel WebSocket + Remote UI HTTP
        # Only root-level WebSocket goes to Chisel server
        location / {
            # Route: WebSocket → Chisel, HTTP → tunnel
            set $backend tunnel;
            if ($http_upgrade = "websocket") {
                set $backend chisel;
            }

            # Auth check (edge proxy allows websocket through, blocks UI if disabled)
            auth_request /_remote_ui_check;
            error_page 403 = @ui_disabled;

            # Rate limit UI requests
            limit_req zone=ui_limit burst=20 nodelay;

            proxy_pass http://$backend;
            proxy_http_version 1.1;

            # WebSocket headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Standard proxy headers
            proxy_set_header Host $host;

            # HARD STRIP proxy headers so HA won't demand trusted_proxies
            # Cloud Run injects these; we must blank them explicitly
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header X-Forwarded-Host "";
            proxy_set_header X-Forwarded-Port "";
            proxy_set_header X-Real-IP "";
            proxy_set_header Forwarded "";

            # Timeouts for WebSocket (60 min = 3600s, but Cloud Run limits to 60 min anyway)
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;

            # Buffer settings
            proxy_buffering off;
        }
    }

    # Connection upgrade mapping
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # OAuth state fix: HA drops state parameter, Google requires it
    # If redirect already has state=, don't add it again
    map $upstream_http_location $oauth_state_suffix {
        default "&state=$arg_state";
        "~state=" "";
    }
}
